<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±è‰²ç³»æŠ½çç³»çµ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ==================================== */
        /* 1. æ·±è‰²ç³» CSS æ¨£å¼ */
        /* ==================================== */
        :root {
            --color-bg-dark: #121212;
            --color-bg-section: #1E1E1E;
            --color-text-light: #E0E0E0;
            --color-accent-purple: #BB86FC;
            --color-accent-red: #CF6679;
            --color-accent-teal: #03DAC6;
            --color-border: #333333;
        }

        body {
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section, #draw-result-section {
            background-color: var(--color-bg-section);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        h2 {
            color: var(--color-accent-purple);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* è¡¨å–®å…ƒç´  */
        input[type="text"], input[type="number"], select {
            background-color: #2A2A2A;
            border: 1px solid #555555;
            color: var(--color-text-light);
            padding: 10px;
            border-radius: 5px;
            width: calc(100% - 22px);
            margin-bottom: 15px;
            box-sizing: border-box; 
        }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid var(--color-border);
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #2A2A2A;
            color: #FFFFFF;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 3px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn:active {
            transform: scale(0.98);
        }

        .btn-draw {
            background-color: var(--color-accent-red); 
            color: #FFFFFF;
            padding: 15px 30px;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
        }
        .btn-draw:hover { background-color: #FF5566; }

        .btn-save, .btn-add {
            background-color: var(--color-accent-teal); 
            color: var(--color-bg-dark);
        }
        .btn-save:hover, .btn-add:hover { background-color: #4DE9D7; }

        /* æ–°å¢åˆªé™¤æ‰€æœ‰åƒèˆ‡äººçš„æŒ‰éˆ•æ¨£å¼ */
        .btn-delete-all {
            background-color: #D32F2F; /* æ›´é†’ç›®çš„ç´…è‰² */
            color: #FFFFFF;
            padding: 10px 15px;
            width: 100%;
            margin-top: 15px;
        }
        .btn-delete-all:hover {
            background-color: #E53935;
        }

        .btn-delete {
            background-color: #555555;
            color: var(--color-text-light);
        }
        .btn-delete:hover { background-color: #777777; }

        /* ä¸­çç‰¹æ•ˆå€å¡Š */
        #winner-display {
            text-align: center;
            padding: 30px;
            margin-top: 20px;
            background-color: #2A2A2A;
            color: var(--color-text-light);
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 10px;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s ease-out;
            min-height: 80px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ä¸­çæ™‚çš„å‹•ç•«æ•ˆæœ */
        .winner-active {
            opacity: 1 !important;
            transform: scale(1) !important;
            background-color: var(--color-accent-purple) !important;
            color: var(--color-bg-dark) !important;
            animation: flashBorder 1.5s infinite alternate; 
        }

        /* é‚Šæ¡†é–ƒçˆå‹•ç•« */
        @keyframes flashBorder {
            from { box-shadow: 0 0 10px var(--color-accent-purple); }
            to { box-shadow: 0 0 40px #FFD700; } 
        }
    </style>
</head>
<body>

    <div class="main-layout">
        
        <div id="product-management" class="section">
            <h2>ğŸ›ï¸ çå“ç®¡ç†</h2>
            <div id="add-prize">
                <input type="text" id="prize-name-input" placeholder="çå“åç¨± (e.g., iPhone 17)">
                <input type="number" id="prize-qty-input" placeholder="æ•¸é‡" value="1" min="1">
                <button class="btn btn-add" onclick="addPrize()">æ–°å¢çå“</button>
            </div>
            
            <h3>çå“æ¸…å–®</h3>
            <table id="prize-list-table">
                <thead>
                    <tr>
                        <th>åç¨±</th>
                        <th>ç¸½æ•¸</th>
                        <th>å·²æŠ½</th>
                        <th>å‰©é¤˜</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div id="participant-draw-management" class="section">
            <h2>ğŸ§‘ åƒèˆ‡äººç®¡ç†</h2>
            <div id="add-participant">
                <input type="text" id="participant-name-input" placeholder="åƒèˆ‡äººå§“å">
                <button class="btn btn-add" onclick="addParticipant()">æ–°å¢åƒèˆ‡äºº</button>
            </div>
            
            <button class="btn btn-delete-all" onclick="deleteAllParticipants()">âš¡ åˆªé™¤æ‰€æœ‰åƒèˆ‡äººç´€éŒ„</button>

            <h3 style="margin-top: 30px;">æŠ½çæ“ä½œ</h3>
            <label for="prize-select">é¸æ“‡è¦æŠ½ççš„çå“:</label>
            <select id="prize-select">
                <option value="">-- è«‹é¸æ“‡ --</option>
                </select>
            
            <button class="btn btn-draw" onclick="handleDrawPrize()">æŠ½å‡º 1 ä½å¾—çè€…</button>

            <h3 style="margin-top: 30px;">åƒèˆ‡äººåå–® (æŠ½çç´€éŒ„)</h3>
            <table id="participant-list-table">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>ç‹€æ…‹</th>
                        <th>ä¸­ççå“</th>
                        <th>æ“ä½œ</th> </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
    
    <div id="draw-result-section" class="section">
        <h2>ğŸ‰ æŠ½ççµæœ</h2>
        <div id="winner-display">
            å°šæœªé€²è¡ŒæŠ½çï¼Œè«‹åœ¨ä¸Šæ–¹é¸æ“‡çå“ä¸¦æŒ‰ä¸‹æŠ½çæŒ‰éˆ•ï¼
        </div>
    </div>


    <script>
        // ====================================
        // 2. Firebase åˆå§‹åŒ–å’Œè³‡æ–™åº«æ“ä½œ
        // ====================================

        // !! è«‹å°‡é€™è£¡çš„é…ç½®æ›¿æ›ç‚ºæ‚¨æä¾›çš„ Firebase é…ç½® !!
        const firebaseConfig = {
            apiKey: "AIzaSyDqMLRGCLVqsbgCcVTFv99J5SxI5XzK_Uw",
            authDomain: "project-2465603039340300163.firebaseapp.com",
            projectId: "project-2465603039340300163",
            storageBucket: "project-2465603039340300163.firebasestorage.app",
            messagingSenderId: "716358251346",
            appId: "1:716358251346:web:c3a468ba4ce2145adf008b"
        };

        // åˆå§‹åŒ– Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            window.db = db; 
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®å’Œç¶²è·¯é€£ç·šã€‚", e);
            alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®å’Œç¶²è·¯é€£ç·šã€‚");
        }


        // é›†åˆåç¨±
        const PRIZES_COLLECTION = 'prizes';
        // é›†åˆåç¨±è®Šæ›´ï¼šå¾ employees è®Šç‚º participants
        const PARTICIPANTS_COLLECTION = 'participants'; 


        // ====================================
        // 3. çå“ç®¡ç†åŠŸèƒ½ (ç„¡è®Šå‹•)
        // ====================================

        function addPrize() {
            if (!window.db) return alert("è³‡æ–™åº«æœªé€£æ¥ã€‚");
            const name = document.getElementById('prize-name-input').value.trim();
            const total = parseInt(document.getElementById('prize-qty-input').value);

            if (!name || total <= 0 || isNaN(total)) {
                alert("è«‹è¼¸å…¥æ­£ç¢ºçš„çå“åç¨±å’Œæ•¸é‡ã€‚");
                return;
            }

            window.db.collection(PRIZES_COLLECTION).add({
                name: name,
                total: total,
                drawn: 0,
                remaining: total
            }).then(() => {
                document.getElementById('prize-name-input').value = '';
                document.getElementById('prize-qty-input').value = '1';
                console.log("çå“æ–°å¢æˆåŠŸ");
            }).catch(error => {
                console.error("æ–°å¢çå“å¤±æ•—: ", error);
                alert("æ–°å¢çå“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase æ¬Šé™ï¼ˆSecurity Rulesï¼‰ã€‚");
            });
        }
        
        // åˆªé™¤çå“ (ä½¿ç”¨æ–‡ä»¶ ID)
        function deletePrize(id) {
             if (!window.db) return alert("è³‡æ–™åº«æœªé€£æ¥ã€‚");
            if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çå“å—ï¼Ÿè«‹ç¢ºèªæ²’æœ‰åƒèˆ‡äººä¸­éæ­¤çé …ã€‚")) {
                window.db.collection(PRIZES_COLLECTION).doc(id).delete()
                    .then(() => console.log("çå“åˆªé™¤æˆåŠŸ"))
                    .catch(error => console.error("åˆªé™¤çå“å¤±æ•—: ", error));
            }
        }


        // ====================================
        // 4. åƒèˆ‡äººç®¡ç†åŠŸèƒ½ (Participant Management)
        // ====================================
        
        function addParticipant() {
             if (!window.db) return alert("è³‡æ–™åº«æœªé€£æ¥ã€‚");
            const name = document.getElementById('participant-name-input').value.trim();
            if (!name) {
                alert("è«‹è¼¸å…¥åƒèˆ‡äººå§“åã€‚");
                return;
            }

            window.db.collection(PARTICIPANTS_COLLECTION).add({
                name: name,
                status: 'pending', // å°šæœªä¸­ç
                prize: ''
            }).then(() => {
                document.getElementById('participant-name-input').value = '';
                console.log("åƒèˆ‡äººæ–°å¢æˆåŠŸ");
            }).catch(error => {
                console.error("æ–°å¢åƒèˆ‡äººå¤±æ•—: ", error);
                alert("æ–°å¢åƒèˆ‡äººå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase æ¬Šé™ï¼ˆSecurity Rulesï¼‰ã€‚");
            });
        }
        
        // å–®ç¨åˆªé™¤åƒèˆ‡äºº
        function deleteParticipant(id, name) {
            if (!window.db) return alert("è³‡æ–™åº«æœªé€£æ¥ã€‚");
            if (confirm(`ç¢ºå®šè¦åˆªé™¤åƒèˆ‡äººã€${name}ã€‘çš„ç´€éŒ„å—ï¼Ÿ`)) {
                window.db.collection(PARTICIPANTS_COLLECTION).doc(id).delete()
                    .then(() => console.log(`åƒèˆ‡äººã€${name}ã€‘åˆªé™¤æˆåŠŸ`))
                    .catch(error => console.error("åˆªé™¤åƒèˆ‡äººå¤±æ•—: ", error));
            }
        }

        // ä¸€éµåˆªé™¤æ‰€æœ‰åƒèˆ‡äººç´€éŒ„
        async function deleteAllParticipants() {
            if (!window.db) return alert("è³‡æ–™åº«æœªé€£æ¥ã€‚");
            
            const confirmMsg = "!!! è­¦å‘Š !!!\n\næ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ‰€æœ‰åƒèˆ‡äººçš„ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚\n\nè«‹è¼¸å…¥ã€ŒDELETE ALLã€ç¢ºèªï¼š";
            const userInput = prompt(confirmMsg);

            if (userInput !== 'DELETE ALL') {
                alert("è¼¸å…¥ä¸ç¬¦ï¼Œæ“ä½œå–æ¶ˆã€‚");
                return;
            }

            try {
                // ç²å–æ‰€æœ‰åƒèˆ‡äººæ–‡ä»¶
                const snapshot = await window.db.collection(PARTICIPANTS_COLLECTION).get();
                
                if (snapshot.empty) {
                    alert("åƒèˆ‡äººæ¸…å–®å·²æ˜¯ç©ºçš„ã€‚");
                    return;
                }

                const batch = window.db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                alert(`æˆåŠŸåˆªé™¤ ${snapshot.size} ç­†åƒèˆ‡äººç´€éŒ„ã€‚`);

            } catch (error) {
                console.error("åˆªé™¤æ‰€æœ‰åƒèˆ‡äººå¤±æ•—: ", error);
                alert("åˆªé™¤æ‰€æœ‰åƒèˆ‡äººç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase æ¬Šé™æˆ–ç¶²è·¯é€£ç·šã€‚");
            }
        }


        // ====================================
        // 5. æŠ½çæ ¸å¿ƒé‚è¼¯ (åƒ…ä¿®æ”¹é›†åˆåç¨±)
        // ====================================
        
        async function handleDrawPrize(drawCount = 1) {
             if (!window.db) return alert("è³‡æ–™åº«æœªé€£æ¥ã€‚");

            const prizeSelect = document.getElementById('prize-select');
            const selectedPrizeId = prizeSelect.value;

            if (!selectedPrizeId) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹çå“ã€‚");
                return;
            }
            
            const selectedOption = prizeSelect.options[prizeSelect.selectedIndex];
            const selectedPrizeName = selectedOption.textContent.replace(/ \(å‰©é¤˜: \d+\)$/, '');


            // 1. æª¢æŸ¥çå“åº«å­˜
            const prizeRef = window.db.collection(PRIZES_COLLECTION).doc(selectedPrizeId);
            const prizeDoc = await prizeRef.get();
            const prizeData = prizeDoc.data();

            if (!prizeData || prizeData.remaining < drawCount) {
                alert(`çå“ã€${prizeData ? prizeData.name : 'N/A'}ã€‘æ•¸é‡ä¸è¶³æˆ–è³‡æ–™ä¸å­˜åœ¨ï¼`);
                return;
            }

            // 2. é¸æ“‡ç¬¦åˆæŠ½çè³‡æ ¼çš„åƒèˆ‡äºº (status: 'pending')
            const eligibleSnapshot = await window.db.collection(PARTICIPANTS_COLLECTION)
                                              .where('status', '==', 'pending')
                                              .get();
            const eligibleParticipants = eligibleSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (eligibleParticipants.length === 0) {
                alert("æ²’æœ‰å¯æŠ½ççš„åƒèˆ‡äººæˆ–æ‰€æœ‰äººéƒ½å·²ä¸­çã€‚");
                return;
            }

            // 3. éš¨æ©Ÿé¸ä¸­å¾—çè€…
            const randomIndex = Math.floor(Math.random() * eligibleParticipants.length);
            const winner = eligibleParticipants[randomIndex];

            // 4. æ›´æ–° Firebase è³‡æ–™åº« (æ‰¹æ¬¡å¯«å…¥ - ç¢ºä¿åŸå­æ€§)
            const batch = window.db.batch();

            // a. æ›´æ–°åƒèˆ‡äººç‹€æ…‹
            const winnerRef = window.db.collection(PARTICIPANTS_COLLECTION).doc(winner.id);
            batch.update(winnerRef, { 
                status: 'won', 
                prize: selectedPrizeName 
            });

            // b. æ›´æ–°çå“åº«å­˜
            batch.update(prizeRef, { 
                drawn: firebase.firestore.FieldValue.increment(drawCount),
                remaining: firebase.firestore.FieldValue.increment(-drawCount)
            });

            try {
                await batch.commit();
                // 5. é¡¯ç¤ºçµæœå’Œç‰¹æ•ˆ
                displayWinner(winner.name, selectedPrizeName);
            } catch (error) {
                console.error("æŠ½çå’Œè³‡æ–™åº«æ›´æ–°å¤±æ•—: ", error);
                alert("æŠ½çå’Œè³‡æ–™åº«æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase æ¬Šé™å’Œç¶²è·¯é€£ç·šã€‚");
            }
        }
        
        // ====================================
        // 6. ä»‹é¢æ›´æ–°èˆ‡ç‰¹æ•ˆ (ä½¿ç”¨ Realtime Listeners)
        // ====================================

        if (window.db) {
            // ç›£è½ Prizes é›†åˆ (å¯¦æ™‚æ›´æ–°çå“æ¸…å–®å’Œä¸‹æ‹‰é¸å–®)
            window.db.collection(PRIZES_COLLECTION).onSnapshot(snapshot => {
                const prizeTableBody = document.getElementById('prize-list-table').getElementsByTagName('tbody')[0];
                const prizeSelect = document.getElementById('prize-select');
                prizeTableBody.innerHTML = '';
                prizeSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>'; 

                snapshot.forEach(doc => {
                    const prize = doc.data();
                    const id = doc.id;

                    // æ›´æ–°è¡¨æ ¼
                    const row = prizeTableBody.insertRow();
                    row.insertCell(0).textContent = prize.name;
                    row.insertCell(1).textContent = prize.total;
                    row.insertCell(2).textContent = prize.drawn;
                    row.insertCell(3).textContent = prize.remaining;
                    
                    const actionCell = row.insertCell(4);
                    actionCell.innerHTML = `<button class="btn btn-delete" onclick="deletePrize('${id}')">åˆªé™¤</button>`;
                    
                    // æ›´æ–°ä¸‹æ‹‰é¸å–® (åªé¡¯ç¤ºæœ‰å‰©é¤˜æ•¸é‡çš„çå“)
                    if (prize.remaining > 0) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = `${prize.name} (å‰©é¤˜: ${prize.remaining})`;
                        prizeSelect.appendChild(option);
                    }
                });
            });

            // ç›£è½ Participants é›†åˆ (å¯¦æ™‚æ›´æ–°åƒèˆ‡äººåå–®å’Œä¸­çç´€éŒ„)
            window.db.collection(PARTICIPANTS_COLLECTION).orderBy('status').onSnapshot(snapshot => {
                const participantTableBody = document.getElementById('participant-list-table').getElementsByTagName('tbody')[0];
                participantTableBody.innerHTML = '';

                snapshot.forEach(doc => {
                    const participant = doc.data();
                    const id = doc.id;
                    const row = participantTableBody.insertRow();
                    row.insertCell(0).textContent = participant.name;
                    row.insertCell(1).textContent = participant.status === 'won' ? 'âœ… å·²ä¸­ç' : 'â³ å¾…æŠ½ç';
                    row.insertCell(2).textContent = participant.prize || 'N/A';
                    
                    // ç¨ç«‹åˆªé™¤æŒ‰éˆ•
                    const actionCell = row.insertCell(3);
                    actionCell.innerHTML = `<button class="btn btn-delete" onclick="deleteParticipant('${id}', '${participant.name}')">åˆªé™¤</button>`;
                });
            });
        }


        // ä¸­ççµæœé¡¯ç¤ºå’Œç‰¹æ•ˆ (ç„¡è®Šå‹•)
        function displayWinner(winnerName, prizeName) {
            const winnerDisplay = document.getElementById('winner-display');
            
            winnerDisplay.innerHTML = `ğŸ‰ æ­å–œ **${winnerName}**ï¼æŠ½ä¸­ **${prizeName}**ï¼ğŸŠ`;
            winnerDisplay.classList.add('winner-active');

            confetti({
                particleCount: 150,
                spread: 90,
                startVelocity: 55,
                origin: { y: 0.7 }
            });
            
            setTimeout(() => {
                winnerDisplay.classList.remove('winner-active');
                winnerDisplay.style.background = ''; 
                winnerDisplay.style.color = '';
                winnerDisplay.innerHTML = 'é»æ“Šä¸Šæ–¹æŒ‰éˆ•é€²è¡Œä¸‹ä¸€è¼ªæŠ½çã€‚';
            }, 6000); 
        }

        // åˆå§‹åŒ–æ™‚ç¢ºä¿é¡¯ç¤ºå€å¡Šè™•æ–¼éœæ­¢ç‹€æ…‹
        window.onload = () => {
            const winnerDisplay = document.getElementById('winner-display');
            if (winnerDisplay) {
                winnerDisplay.innerHTML = 'å°šæœªé€²è¡ŒæŠ½çï¼Œè«‹åœ¨ä¸Šæ–¹é¸æ“‡çå“ä¸¦æŒ‰ä¸‹æŠ½çæŒ‰éˆ•ï¼';
                winnerDisplay.style.opacity = '1';
                winnerDisplay.style.transform = 'scale(1)';
            }
        };

    </script>
</body>
</html>